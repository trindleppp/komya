<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blob Metaball (日本語UI + ランダムカラー)</title>
  <style>
    html,body { margin:0; height:100%; background:#111; }
    #app { position:fixed; inset:0; display:grid; place-items:center; }
    #controls {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      z-index:10;
    }
    #controls button {
      padding:10px 16px;
      border:0; border-radius:12px;
      cursor:pointer;
      background:#222; color:#eee;
      font-size:15px;
      box-shadow:0 2px 6px rgba(0,0,0,0.5);
    }
    #controls button:hover { filter:brightness(1.2); }
  </style>
</head>
<body>
  <div id="app"></div>
  <!-- ランダムカラー ボタン -->
  <div id="controls"><button id="randomize">ランダムカラー</button></div>

  <script type="module">
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";
  import { Pane } from "https://cdn.jsdelivr.net/npm/tweakpane@4.0.4/dist/tweakpane.min.js";

  // ===== 設定 =====
  const INTERNAL_W = 1200, INTERNAL_H = 1200;
  const TAU = Math.PI * 2;
  const rand = (a,b)=> a + Math.random()*(b-a);

  // ===== シェーダ =====
  const VERT = `
    precision highp float;
    attribute vec3 position;
    varying vec2 vUv;
    void main() {
      vUv = position.xy * 0.5 + 0.5;
      gl_Position = vec4(position, 1.0);
    }
  `;
  const FRAG = `
    precision highp float;
    varying vec2 vUv;
    uniform vec2 centers[32];
    uniform float radii[32];
    uniform int num_circles;
    uniform vec3 blob_color;

    uniform vec2 eye_center;
    uniform float eye_radius;
    uniform vec2 pupil_center;
    uniform float pupil_radius;
    uniform vec3 eye_color;
    uniform vec3 pupil_color;

    uniform vec2 resolution;

    void main(){
        vec2 uv = vUv * resolution;
        float field = 0.0;
        for(int i=0;i<32;i++){
            if(i >= num_circles) break;
            vec2 d = uv - centers[i];
            float d2 = dot(d,d) + 1.0;
            float r = radii[i];
            field += (r*r) / d2;
        }
        if(field <= 0.8){ discard; }

        if(length(uv - pupil_center) < pupil_radius){
            gl_FragColor = vec4(pupil_color, 1.0); return;
        }
        if(length(uv - eye_center) < eye_radius){
            gl_FragColor = vec4(eye_color, 1.0); return;
        }
        gl_FragColor = vec4(blob_color, 1.0);
    }
  `;

  // ===== ランダム色生成 =====
  function randomColor(){
    let r,g,b;
    do {
      r=Math.random(); g=Math.random(); b=Math.random();
    } while(r>0.9 && g>0.9 && b>0.9); // 真っ白すぎを避ける
    return new THREE.Vector3(r,g,b);
  }

  // ===== Blob クラス（省略：前回のまま） =====
  // ここは前に送った Blob, BlobRenderer, applyForces, tick の内容と同じ
  // ※コードを短くするため説明省略、実際はそのままペーストすればOK

  // ...（Blob クラス）
  // ...（BlobRenderer クラス）
  // ...（Three.js setup）
  // ...（blobs 生成）

  // ===== UI =====
  const pane=new Pane({title:'調整パネル'});
  const params={ 
    eye_range:30,     // 目の動ける範囲
    interval:1.5,     // 目の動きの間隔
    eye_scale:1.4,    // 目の大きさ
    attract:10,       // 引き合う力
    repel:10,         // 押し返す力
    move_speed:100,   // 動く速さ
    cohesion:1.0      // 内部のまとまり具合
  };
  pane.addBinding(params,'eye_range',{label:'目の範囲',min:10,max:200,step:1});
  pane.addBinding(params,'interval',{label:'目の間隔',min:0.5,max:5,step:0.1});
  pane.addBinding(params,'eye_scale',{label:'目の大きさ',min:1,max:3,step:0.05});
  pane.addBinding(params,'attract',{label:'引力',min:0,max:100,step:1});
  pane.addBinding(params,'repel',{label:'反発',min:0,max:150,step:1});
  pane.addBinding(params,'move_speed',{label:'移動速度',min:20,max:200,step:1});
  pane.addBinding(params,'cohesion',{label:'まとまり',min:0,max:5,step:0.1});

  // ===== ランダムカラー ボタン =====
  document.getElementById('randomize').addEventListener('click',()=>{
    for(const b of blobs){
      b.color = randomColor();
      b.pupil_color = randomColor();
    }
  });

  </script>
</body>
</html>
